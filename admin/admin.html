 <!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Admin â€“ Salon Mireille BeautÃ©</title>
  <link rel="stylesheet" href="admin.css" />
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body { font-family: sans-serif; max-width: 900px; margin: auto; padding: 20px; }
    .reservation { border: 1px solid #ccc; padding: 10px; margin: 10px 0; background: #f9f9f9; }
    #calendrier { margin-top: 40px; }
  </style>
</head>
<body>
  <a href="admin-dashboard.html">
    <button style="padding: 10px 20px; font-size: 16px; font-weight: bold; background-color: #4caf50; color: white; border: none; border-radius: 6px; cursor: pointer; box-shadow: 0 2px 6px rgba(0,0,0,0.2); transition: background-color 0.3s ease;">
      ğŸ“Š AccÃ©der au tableau de bord
    </button>
  </a>
  <h1>ğŸ“‹ RÃ©servations du salon Mireille BeautÃ©</h1>

  <div id="zoneConnexion" style="margin-bottom: 20px;">
    <label for="adminPassword">Mot de passe admin :</label>
    <input type="password" id="adminPassword" />
    <button onclick="validerMotDePasse()">âœ… Valider</button>
  </div>

  <button onclick="toggleCreneaux()" style="margin-top: 20px;">âš™ï¸ GÃ©rer les crÃ©neaux</button>
  <div id="gestionCreneaux" style="display: none; margin-top: 10px;">
    <input type="text" id="nouveauCreneau" placeholder="Ex: 17:00" />
    <button onclick="ajouterCreneau()">â• Ajouter</button>
    <select id="creneauASupprimer"></select>
    <button onclick="retirerCreneau()">â– Retirer</button>
  </div>

  <button onclick="toggleFiltres()" style="margin-top: 20px;">ğŸ” Afficher les filtres</button>
  <div id="blocFiltres" style="display: none; margin-top: 10px;">
    <label for="rechercheNom">Nom :</label>
    <input type="text" id="rechercheNom" oninput="chargerReservations()" placeholder="Ex: Mireille" />
    <label for="filtreDate">Date :</label>
    <select id="filtreDate" onchange="chargerReservations()">
      <option value="">-- Toutes les dates --</option>
      <option value="2025-09-01">1 septembre 2025</option>
      <option value="2025-09-02">2 septembre 2025</option>
    </select>
    <label for="filtreCoiffure">Coiffure :</label>
    <select id="filtreCoiffure" onchange="chargerReservations()">
      <option value="">-- Toutes --</option>
      <option value="Brushing">Brushing</option>
      <option value="Coloration">Coloration</option>
      <option value="Tresses">Tresses</option>
      <option value="Extensions">Extensions</option>
      <option value="Soins capillaires">Soins capillaires</option>
      <option value="Coiffure Ã©vÃ©nementielle">Coiffure Ã©vÃ©nementielle</option>
      <option value="Perruques">Perruques</option>
    </select>
    <label for="tri">Trier par :</label>
    <select id="tri" onchange="chargerReservations()">
      <option value="recent">RÃ©cent en premier</option>
      <option value="date">Date croissante</option>
      <option value="coiffure">Coiffure A-Z</option>
    </select>
  </div>

  <button onclick="toggleReservations()" id="btnReservations">ğŸ“‹ Afficher les rÃ©servations</button>
  <button onclick="exporterPDF()">ğŸ“„ Exporter en PDF</button>
  <button onclick="toggleCalendrier()" id="btnCalendrier">ğŸ“… Voir le calendrier</button>

  <div id="reservations" style="display: none;"></div>
  <div id="calendrier" style="display: none;"></div>

  <script>
    const BASE_URL = "https://mkbeauty-backend.onrender.com";
    let motDePasseAdmin = "";
    let sessionActive = false;

    function validerMotDePasse() {
      const champ = document.getElementById("adminPassword");
      const motDePasse = champ.value.trim();
      if (!motDePasse) return alert("â›” Veuillez entrer le mot de passe.");
      motDePasseAdmin = motDePasse;
      sessionActive = true;
      document.getElementById("zoneConnexion").style.display = "none";
      alert("âœ… Mot de passe validÃ© !");
    }

    function toggleCreneaux() {
      const bloc = document.getElementById("gestionCreneaux");
      bloc.style.display = bloc.style.display === "none" ? "block" : "none";
    }

    function toggleFiltres() {
      const bloc = document.getElementById("blocFiltres");
      bloc.style.display = bloc.style.display === "none" ? "block" : "none";
    }

    async function ajouterCreneau() {
      if (!sessionActive || !motDePasseAdmin) return alert("â›” Mot de passe requis.");
      const heure = document.getElementById("nouveauCreneau").value.trim();
      if (!heure) return alert("â›” Heure requise.");
      await fetch(`${BASE_URL}/admin/creneaux`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "x-admin-password": motDePasseAdmin
        },
        body: JSON.stringify({ heure })
      });
      chargerListeCreneaux();
    }

    async function retirerCreneau() {
      if (!sessionActive || !motDePasseAdmin) return alert("â›” Mot de passe requis.");
      const heure = document.getElementById("creneauASupprimer").value;
      await fetch(`${BASE_URL}/admin/creneaux/${heure}`, {
        method: "DELETE",
        headers: { "x-admin-password": motDePasseAdmin }
      });
      chargerListeCreneaux();
    }

    async function chargerListeCreneaux() {
      const res = await fetch(`${BASE_URL}/creneaux`);
      const data = await res.json();
      const select = document.getElementById("creneauASupprimer");
      select.innerHTML = "";
      data.forEach(h => {
        const opt = document.createElement("option");
        opt.value = h;
        opt.textContent = h;
        select.appendChild(opt);
      });
    }

    async function chargerReservations() {
      if (!sessionActive || !motDePasseAdmin) return alert("â›” Mot de passe requis.");
      const date = document.getElementById("filtreDate").value;
      const coiffure = document.getElementById("filtreCoiffure").value;
      const tri = document.getElementById("tri").value;
      const rechercheNom = document.getElementById("rechercheNom").value.trim().toLowerCase();

      let url = `${BASE_URL}/admin/reservations?`;
      if (date) url += `date=${date}&`;
      if (coiffure) url += `coiffure=${encodeURIComponent(coiffure)}&`;

      const res = await fetch(url, { headers: { "x-admin-password": motDePasseAdmin } });
      const container = document.getElementById("reservations");
      container.innerHTML = "";

      if (!res.ok) return container.innerHTML = "<p>â›” AccÃ¨s refusÃ© ou erreur serveur.</p>";

      let data = await res.json();
      if (rechercheNom) data = data.filter(r => r.nom.toLowerCase().includes(rechercheNom));

      if (tri === "date") {
        data.sort((a, b) => a.date.localeCompare(b.date) || a.heure.localeCompare(b.heure));
      } else if (tri === "coiffure") {
        data.sort((a, b) => a.coiffure.localeCompare(b.coiffure));
      } else {
        data.sort((a, b) => b._id.localeCompare(a._id));
      }

            if (data.length === 0) return container.innerHTML = "<p>Aucune rÃ©servation trouvÃ©e.</p>";

      data.forEach(r => {
        const bloc = document.createElement("div");
        bloc.className = "reservation";
        bloc.innerHTML = `
          <p><strong>Nom :</strong> <a href="client.html?id=${r._id}" target="_blank">${r.nom}</a></p>
          <p><strong>Date :</strong> ${r.date}</p>
          <p><strong>Heure :</strong> ${r.heure}</p>
          <p><strong>Coiffure :</strong> ${r.coiffure}</p>
          <button onclick="envoyerRappel('${r._id}')">ğŸ“² Rappel</button>
          <button onclick="supprimerReservation('${r._id}')">ğŸ—‘ Supprimer</button>
        `;
        container.appendChild(bloc);
      });
    }

    async function envoyerRappel(id) {
      if (!sessionActive || !motDePasseAdmin) return alert("â›” Mot de passe requis.");
      try {
        const res = await fetch(`${BASE_URL}/admin/rappel/${id}`, {
          method: "POST",
          headers: { "x-admin-password": motDePasseAdmin }
        });
        alert(res.ok ? "âœ… Rappel envoyÃ© !" : "â›” Ã‰chec de l'envoi du rappel.");
      } catch (err) {
        console.error("âŒ Erreur rÃ©seau :", err);
        alert("â›” Impossible de contacter le serveur.");
      }
    }

    async function supprimerReservation(id) {
      if (!id || !motDePasseAdmin) return alert("â›” ID ou mot de passe manquant.");
      if (!confirm("ğŸ—‘ Supprimer cette rÃ©servation ?")) return;
      try {
        const res = await fetch(`${BASE_URL}/admin/reservations/${id}`, {
          method: "DELETE",
          headers: { "x-admin-password": motDePasseAdmin }
        });
        if (res.ok) {
          alert("âœ… RÃ©servation supprimÃ©e !");
          chargerReservations();
        } else {
          alert("â›” Ã‰chec de la suppression.");
        }
      } catch (err) {
        console.error("âŒ Erreur rÃ©seau :", err);
        alert("â›” Impossible de contacter le serveur.");
      }
    }

    async function exporterPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      let y = 20;

      doc.setFontSize(16);
      doc.text("Salon Mireille BeautÃ© â€“ RÃ©servations", 10, 10);

      const blocs = document.querySelectorAll(".reservation");
      if (blocs.length === 0) {
        alert("â›” Aucune rÃ©servation Ã  exporter.");
        return;
      }

      blocs.forEach((bloc) => {
        const lignes = bloc.innerText.split("\n");
        lignes.forEach((ligne) => {
          doc.setFontSize(12);
          doc.text(ligne, 10, y);
          y += 7;
        });
        y += 5;
        if (y > 250) {
          doc.addPage();
          y = 20;
        }
      });

      doc.text("Signature : Mireille, propriÃ©taire du Salon Mireille BeautÃ©", 10, y + 10);
      doc.save("reservations_mireille.pdf");
    }

    async function toggleCalendrier() {
      if (!sessionActive || !motDePasseAdmin) return alert("â›” Mot de passe requis.");
      const bloc = document.getElementById("calendrier");
      const bouton = document.getElementById("btnCalendrier");

      if (!bloc.hasChildNodes()) {
        const res = await fetch(`${BASE_URL}/admin/reservations`, {
          headers: { "x-admin-password": motDePasseAdmin }
        });
        const data = await res.json();
        const events = data.map(r => ({
          title: r.nom,
          start: `${r.date}T${r.heure}`,
          url: `client.html?id=${r._id}`
        }));

        const calendarInstance = new FullCalendar.Calendar(bloc, {
          initialView: "dayGridMonth",
          locale: "fr",
          events: events,
          eventClick: function(info) {
            info.jsEvent.preventDefault();
            if (info.event.url) window.open(info.event.url, "_blank");
          }
        });

        calendarInstance.render();
      }

      const visible = bloc.style.display === "block";
      bloc.style.display = visible ? "none" : "block";
      bouton.textContent = visible ? "ğŸ“… Voir le calendrier" : "ğŸ“… Masquer le calendrier";
    }

    window.onload = () => {
      chargerListeCreneaux();
      chargerReservations();
    };
  </script>
</body>
</html>